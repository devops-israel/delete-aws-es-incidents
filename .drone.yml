build:
  image: golang:1.8
  pull: true
  environment:
    - SHA1=$$COMMIT
    - BUILD_NUMBER=$$BUILD_NUMBER
    - VERSION=0.0.1
    - GITHUB_TOKEN=$$GITHUB_TOKEN
  commands:
    - mkdir -p prod
    - curl https://glide.sh/get | sh
    - go get github.com/mitchellh/gox
    - go get github.com/tcnksm/ghr
    - sed -i "s~delete-aws-es-incidents~github.com/devops-israel/delete-aws-es-incidents~g" main.go
    - glide install
    - glide update
    - gox -output "dist/delete-aws-es-incidents-{{.OS}}-{{.Arch}}" -osarch="linux/amd64 darwin/amd64"
    - ghr -t $GITHUB_TOKEN -u devops-israel -r delete-aws-es-incidents --replace v$VERSION dist/

publish:
  docker:
    username: $$REGISTRY_USER
    password: $$REGISTRY_PASS
    email: $$REGISTRY_EMAIL
    repo: $$DOCKER_REPO
    tag:
        - "$$BUILD_NUMBER"
        - "latest"
    force_tag: true
    file: Dockerfile
    context: prod/
    build_args:
      - version=$VERSION
    when:
      branch: [master]
